
<script>
    export default class extends Lego
    {
        state =
        {
            id: null,
            lesson_id: null,
            name: 'Questionário sem nome',
            presentation_text: '',
            test_data: { questions: [] },
            min_percent_for_approval: 70,

            searchPictureEnabled: null
        }

        changeField(e)
        {
            this.render({ ...this.state, [e.target.name]: e.target.value });
        }

        moveQuestion(e)
        {
            const questIndex = Number.parseInt(e.target.dataset.qi);
            const dir = e.target.dataset.direction;

            switch (dir)
            {
                case "up":
                    if (questIndex <= 0) 
                        break;

                    {
                        const prevQuestion = this.state.test_data.questions.at(questIndex - 1);
                        const thisQuestion = this.state.test_data.questions.at(questIndex);
                        const newQuestions = this.state.test_data.questions
                            .with(questIndex - 1, thisQuestion)
                            .with(questIndex, prevQuestion);

                        this.render({ ...this.state, test_data: { ...this.state.test_data, questions: newQuestions } });
                    }
                    break;
                case "down":
                    if (questIndex >= this.state.test_data.questions.length - 1) 
                        break;

                    {
                        const nextQuestion = this.state.test_data.questions.at(questIndex + 1);
                        const thisQuestion = this.state.test_data.questions.at(questIndex);
                        const newQuestions = this.state.test_data.questions
                            .with(questIndex + 1, thisQuestion)
                            .with(questIndex, nextQuestion);

                        this.render({ ...this.state, test_data: { ...this.state.test_data, questions: newQuestions } });
                    }
                    break;
            }
        }

        addQuestion()
        {
            this.render({ ...this.state, test_data: { ...this.state.test_data, questions: [ ...this.state.test_data.questions, this.questionDefault() ] }})
        }

        removeQuestion(e)
        {
            const index = Number.parseInt(e.target.dataset.qi);

            if (typeof index === "number" && this.state.test_data.questions.at(index))
                this.render({ ...this.state, test_data: { ...this.state.test_data, questions: this.state.test_data.questions.filter((_, i) => i !== index) }});  
        }

        mutateQuestion(e)
        {
            const index = Number.parseInt(e.target.dataset.qi);
            const field = e.target.dataset.qfield;

            const thisQuestion = this.state.test_data.questions.at(index);
            if (thisQuestion && field in thisQuestion)
            {
                thisQuestion[field] = e.target.value;
                this.render({ ...this.state, test_data: { ...this.state.test_data, questions: this.state.test_data.questions.with(index, thisQuestion)  }});
            }
        }

        mutateOption(e)
        {
            const questIndex = Number.parseInt(e.target.dataset.qi);
            const optIndex = Number.parseInt(e.target.dataset.oi);
            const field = e.target.dataset.ofield;

            const thisQuestion = this.state.test_data.questions.at(questIndex);
            const thisOption = thisQuestion?.options?.at(optIndex);

            if (thisQuestion && thisOption && field in thisOption)
            {
                const newOption = { ...thisOption, [field]: e.target.value };
                thisQuestion.options = thisQuestion.options.with(optIndex, newOption);

                this.render({ ...this.state, test_data: { ...this.state.test_data, questions: this.state.test_data.questions.with(questIndex, thisQuestion)  }});
            }
        }

        mutateCorrectAnswers(e)
        {
            const isCorrect = e.target.checked;
            const questIndex = Number.parseInt(e.target.dataset.qi);
            const optIndex = Number.parseInt(e.target.dataset.oi);

            const thisQuestion = this.state.test_data.questions.at(questIndex);
            const thisOption = thisQuestion?.options?.at(optIndex);

            if (thisQuestion)
            {
                const newOption = { ...thisOption, isCorrect: isCorrect };
                thisQuestion.options = thisQuestion.options.with(optIndex, newOption);

                this.render({ ...this.state, test_data: { ...this.state.test_data, questions: this.state.test_data.questions.with(questIndex, thisQuestion)  }});
            }
        }

        setQuestionPicture(qi, picId)
        {
            this.mutateQuestion({ target: { dataset: { qi, qfield: 'pictureMediaId' }, value: picId }});
            this.render({ ...this.state, searchPictureEnabled: null });
        }

        setOptionPicture(qi, oi, picId)
        {
            this.mutateOption({ target: { dataset: { qi, oi, ofield: 'pictureMediaId' }, value: picId }});
            this.render({ ...this.state, searchPictureEnabled: null });
            this.shadowRoot.getElementById(`quest${qi}_opt${oi}_search_picdiag`).close();
        }

        searchPictureQuestion(e)
        {
            const index = Number.parseInt(e.target.dataset.qi);

            if (this.isSearchingPicture([ 'question', index ]))
            {
                this.render({ ...this.state, searchPictureEnabled: null});
                return;
            }

            this.render({ ...this.state, searchPictureEnabled: ['question', index ]});
        }

        searchPictureOption(e)
        {
            const questIndex = Number.parseInt(e.target.dataset.qi);
            const optIndex = Number.parseInt(e.target.dataset.oi);

            if (this.isSearchingPicture(['option', questIndex, optIndex]))
            {
                this.render({ ...this.state, searchPictureEnabled: null});
                return;
            }

            this.render({ ...this.state, searchPictureEnabled: ['option', questIndex, optIndex ]});
            this.shadowRoot.getElementById(`quest${questIndex}_opt${optIndex}_search_picdiag`).showModal();
        }

        closeSearchPicDiag(e)
        {
            const questIndex = Number.parseInt(e.target.dataset.qi);
            const optIndex = Number.parseInt(e.target.dataset.oi);

            if (e.target.hasAttribute('data-preset'))
                this.setOptionPicture(questIndex, optIndex, e.target.getAttribute('data-preset') || null);
            else
                this.render({ ...this.state, searchPictureEnabled: null});

            this.shadowRoot.getElementById(`quest${questIndex}_opt${optIndex}_search_picdiag`).close();
        }

        addOption(e)
        {
            const questIndex = Number.parseInt(e.target.dataset.qi);
            const question = this.state.test_data.questions.at(questIndex);
            const options = question?.options;

            if (options)
            {
                question.options = [ ...options, this.optionDefault() ];

                const questions = this.state.test_data.questions.with(questIndex, question);
                this.render({ ...this.state, test_data: { ...this.state.test_data, questions } });
            }
        }

        removeOption(e)
        {
            const questIndex = Number.parseInt(e.target.dataset.qi);
            const optionIndex = Number.parseInt(e.target.dataset.oi);

            const question = this.state.test_data.questions.at(questIndex);
            const options = question?.options;

            if (options && options.at(optionIndex))
            {
                question.options = options.filter((_, i) => i !== optionIndex);

                const questions = this.state.test_data.questions.with(questIndex, question);
                this.render({ ...this.state, test_data: { ...this.state.test_data, questions } });
            }
        }

        checkQuestionsHaveCorrectAnswers()
        {
            return this.state.test_data.questions.every(quest => quest.options.find(opt => opt.isCorrect) ? true : false);
        }

        checkQuestionsHaveOptions()
        {
            return this.state.test_data.questions.every(quest => quest.options.length > 0);
        }

        submit(e)
        {
            e.preventDefault();

            if (!this.checkQuestionsHaveOptions())
            {
                Parlaflix.Alerts.push(Parlaflix.Alerts.types.error, "Todas as questões devem ter pelo menos uma alternativa!");
                return false;
            }

            if (!this.checkQuestionsHaveCorrectAnswers())
            {
                Parlaflix.Alerts.push(Parlaflix.Alerts.types.error, "Todas as questões devem ter pelo menos uma alternativa definida como correta!");
                return false;
            }


            const { searchPictureEnabled, ...data} = this.state;
            const courseId = this.getAttribute('course_id') || 0;

            import(Parlaflix.functionUrl(`/admin/panel/courses/${courseId}`))
            .then(({ saveTestSkel }) => saveTestSkel(data))
            .then(Parlaflix.Alerts.pushFromJsonResult)
            .then(([ret, jsonDecoded]) =>
            {
                if (jsonDecoded.newId)
                    window.location.reload();
            })
            .catch(Parlaflix.Alerts.pushError("Erro ao salvar questionário!"));
        }

        connected()
        {
            if (this.hasAttribute('test-data-json') && this.getAttribute('test-data-json'))
                this.render({ ...this.state, test_data: JSON.parse(this.getAttribute('test-data-json')) });
        }

        questionDefault()
        {
            return { 
                pictureMediaId: null,
                text: '',
                options: [],
                studentAnswers: null
            };
        }

        optionDefault()
        {
            return {
                pictureMediaId: null,
                text: '',
                isCorrect: false
            };
        }

        isSearchingPicture(expectedArr)
        {
            const arr1 = this.state.searchPictureEnabled;
            const arr2 = expectedArr;

            if (arr1 === arr2) return true; // Check if they are the exact same reference
            if (arr1 == null || arr2 == null) return false; // Check for null/undefined
            if (arr1.length !== arr2.length) return false; // Check if lengths are different

            for (let i = 0; i < arr1.length; i++) {
                // For arrays of objects or nested arrays, you would need a deep comparison function here
                if (arr1[i] !== arr2[i]) return false;
            }

            return true;
        }

        searchPictureQuestionCallback({ detail: { id } })
        {
            const qi = this.state.searchPictureEnabled?.at(0) === 'question' ? this.state.searchPictureEnabled?.at(1) : null;
            this.setQuestionPicture(qi, id || null);
        }

        searchPictureOptionCallback({ detail: { id }})
        {
            const qi = this.state.searchPictureEnabled?.at(0) === 'option' ? this.state.searchPictureEnabled?.at(1) : null;
            const oi = this.state.searchPictureEnabled?.at(0) === 'option' ? this.state.searchPictureEnabled?.at(2) : null;
            this.setOptionPicture(qi, oi, id || null);
        }
    }
</script>

<template>
    <form @submit="submit">
        <fieldset class="fieldset">
            <legend>Informações do Questionário</legend>
            <ext-label label="Nome"><input type="text" name="name" :value="state.name" @change="changeField" required/></ext-label>
            <ext-label label="Texto introdutório" linebreak>
                <textarea class="w-full" type="text" name="presentation_text" :value="state.presentation_text" @change="changeField" rows="5"></textarea>
            </ext-label>
            <ext-label label="Nota mínima para aprovação"><input type="number" min="0" max="100" step="1" name="min_percent_for_approval" :value="state.min_percent_for_approval" @change="changeField" required/> %</ext-label>
        </fieldset>
        <fieldset class="fieldset">
            <legend>Questões</legend>
            <ol :if="Array.isArray(state.test_data.questions)" class="list-decimal pl-8">
                <li :for="quest, qi in state.test_data.questions" class="list-item">
                    <ext-label label="Enunciado" linebreak>
                        <textarea data-qfield="text" data-qi="${qi}" :value="quest.text" rows="5" class="w-full" @change="mutateQuestion" required></textarea>
                    </ext-label>

                    <div class="ml-2">
                        <label>Imagem anexa (opcional):
                            <input type="number" min="1" step="1" @change="mutateQuestion" :value="quest.pictureMediaId || ''"/>
                        </label>
                        <button type="button" class="btn ml-2" data-qi="${qi}" @click="searchPictureQuestion">Procurar</button>
                        <media-client-select 
                            :if="this.isSearchingPicture(['question', qi])"
                            @set-id-field-callback="searchPictureQuestionCallback"
                        ></media-client-select>
                    </div>
                    
                    <div class="mt-4">
                        <span class="font-bold block">Alternativas:</span> 
                        <ol :if="Array.isArray(quest.options)" class="list-[lower-alpha] pl-4">
                            <li :for="opt, oi in quest.options" class="list-item mb-2">
                                <div class="flex flex-row">
                                    <input class="grow mr-2" type="text" data-qi="${qi}" data-oi="${oi}" data-ofield="text" :value="opt.text" @change="mutateOption" />
                                    <button type="button" class="shrink btn mr-2" data-qi="${qi}" data-oi="${oi}" @click="searchPictureOption">Figura: ${opt.pictureMediaId || 'Nenhuma'}</button>
                                    <label class="shrink mr-2">
                                        <input type="checkbox" data-qi="${qi}" data-oi="${oi}" :checked="opt.isCorrect" @change="mutateCorrectAnswers"/> correta
                                    </label>
                                    <button type="button" class="shrink btn min-w-[32px]" data-qi="${qi}" data-oi="${oi}" @click="removeOption">&times;</button>

                                    <dialog id="quest${qi}_opt${oi}_search_picdiag" class="md:w-[700px] w-screen h-screen backdrop:bg-gray-700/60 p-4 bg-neutral-100 dark:bg-neutral-800 m-auto">
                                        <media-client-select 
                                            :if="this.isSearchingPicture(['option', qi, oi])" 
                                            @set-id-field-callback="searchPictureOptionCallback"
                                        ></media-client-select>
                                        <div class="text-center mt-4">
                                            <button type="button" class="btn mr-2" data-qi="${qi}" data-oi="${oi}" @click="closeSearchPicDiag">Fechar</button>
                                            <button type="button" class="btn" data-qi="${qi}" data-oi="${oi}" data-preset="" @click="closeSearchPicDiag">Nenhuma</button>
                                        </div>
                                    </dialog>
                                </div>
                            </li>
                        </ol>
                        <button type="button" class="btn mt-2" data-qi="${qi}" @click="addOption">+ Alternativa</button>
                    </div>

                    <div class="text-right my-2">
                        <button type="button" class="btn min-w-[32px] mr-2" data-qi="${qi}" data-direction="up" @click="moveQuestion">&#8593;</button>
                        <button type="button" class="btn min-w-[32px] mr-2" data-qi="${qi}" data-direction="down" @click="moveQuestion">&#8595;</button>
                        <button type="button" class="btn mr-2" data-qi="${qi}" @click="removeQuestion">&times; Remover questão</button>
                    </div>
                    <hr/>
                </li>
            </ol>

            <button class="btn my-2" type="button" @click="addQuestion">+ Adicionar questão</button>
        </fieldset>

        <div class="text-center mt-4">
            <button type="submit" class="btn">Salvar</button>
        </div>
    </form>
    
</template>